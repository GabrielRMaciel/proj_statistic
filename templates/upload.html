{% extends "layout.html" %}

{% block title %}Enviar Arquivo{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="upload-card">
            <div class="text-center">
                <i class="fas fa-file-csv upload-icon"></i>
                <h2>Enviar Novo Arquivo de Dados</h2>
                <p>Selecione um arquivo .csv para adicioná-lo à base de análise.</p>
            </div>
            
            <form id="upload-form" method="post" enctype="multipart/form-data" class="mt-4">
                <div class="custom-file">
                    <input type="file" class="custom-file-input" name="file" id="file-input" accept=".csv" required>
                    <label class="custom-file-label" for="file-input">Escolher arquivo...</label>
                </div>
                <button type="submit" class="btn btn-primary btn-block mt-4">
                    <i class="fas fa-cogs"></i> Processar Arquivo
                </button>
            </form>

            <div id="progress-wrapper" class="mt-4" style="display: none;">
                <div class="progress">
                    <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                </div>
                <p id="progress-status" class="text-center mt-2"></p>
            </div>
            
            <div id="alert-area" class="mt-3"></div>

        </div>
    </div>
</div>

<script>
    document.getElementById('file-input').addEventListener('change', function(e) {
        var fileName = e.target.files[0] ? e.target.files[0].name : "Escolher arquivo...";
        e.target.nextElementSibling.innerText = fileName;
    });

    const form = document.getElementById('upload-form');
    const fileInput = document.getElementById('file-input');
    const progressBar = document.getElementById('progress-bar');
    const progressWrapper = document.getElementById('progress-wrapper');
    const progressStatus = document.getElementById('progress-status');
    const alertArea = document.getElementById('alert-area');

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!fileInput.files[0]) {
            showAlert('Por favor, selecione um arquivo primeiro.', 'warning');
            return;
        }

        progressWrapper.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';
        progressBar.classList.remove('bg-success', 'bg-danger');
        progressStatus.textContent = 'Enviando arquivo...';
        alertArea.innerHTML = '';

        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();

        xhr.upload.addEventListener('progress', function(e) {
            if (e.lengthComputable) {
                const percentComplete = Math.round((e.loaded / e.total) * 100);
                progressBar.style.width = percentComplete + '%';
                progressBar.textContent = percentComplete + '%';
            }
        });

        xhr.addEventListener('load', function() {
            if (xhr.status === 200) {
                const response = JSON.parse(xhr.responseText);
                if (response.success) {
                    progressBar.style.width = '100%';
                    progressBar.textContent = '100% - Processando...';
                    progressStatus.textContent = 'Arquivo enviado com sucesso! Redirecionando...';
                    progressBar.classList.add('bg-success');
                    setTimeout(() => {
                        window.location.href = response.redirect_url;
                    }, 1500);
                } else {
                    handleError(response.message);
                }
            } else {
                handleError('Erro no servidor: ' + xhr.statusText);
            }
        });

        xhr.addEventListener('error', function() {
            handleError('Erro de rede. Não foi possível conectar ao servidor.');
        });
        
        xhr.open('POST', '{{ url_for("upload_file") }}');
        xhr.send(formData);
    });

    function handleError(message) {
        progressBar.style.width = '100%';
        progressBar.textContent = 'Falha';
        progressBar.classList.add('bg-danger');
        progressStatus.textContent = 'Ocorreu um erro.';
        showAlert(message, 'danger');
    }

    function showAlert(message, type) {
        alertArea.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }
</script>
{% endblock %}